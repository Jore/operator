'use strict';var _extends=Object.assign||function(b){for(var d,c=1;c<arguments.length;c++)for(var f in d=arguments[c],d)Object.prototype.hasOwnProperty.call(d,f)&&(b[f]=d[f]);return b},_loop=require('loop.js'),_loop2=_interopRequireDefault(_loop),_delegate=require('delegate'),_delegate2=_interopRequireDefault(_delegate),_nanoajax=require('nanoajax'),_nanoajax2=_interopRequireDefault(_nanoajax),_navigo=require('navigo'),_navigo2=_interopRequireDefault(_navigo),_dom=require('./dom'),_dom2=_interopRequireDefault(_dom),_util=require('./util');Object.defineProperty(exports,'__esModule',{value:!0});function _interopRequireDefault(b){return b&&b.__esModule?b:{default:b}}var history=window.history,router=new _navigo2.default(_util.origin),state={_state:{route:'',title:'',prev:{route:'/',title:''}},get route(){return this._state.route},set route(b){this._state.prev.route=this.route,this._state.route=b,(0,_util.setActiveLinks)(b)},get title(){return this._state.title},set title(b){this._state.prev.title=this.title,this._state.title=b,document.title=b}};exports.default=function(){function b(p){var q=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,r=arguments[2],s=(0,_util.sanitize)(p);r?null:(0,_util.saveScrollPosition)(),m.emit('before:route',{route:s}),state.paused||d(_util.origin+'/'+s,function(u){r?router.resolve(s):router.navigate(s),f(s,u),m.emit('after:route',{route:s,title:u}),q?q(s,u):null})}function d(p,q){return _nanoajax2.default.ajax({method:'GET',url:p},function(r,s,u){return 200>u.status||300<u.status&&304!==u.status?void(window.location=_util.origin+'/'+state._state.prev.route):void n(u.response,q)})}function f(p){var q=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;state.route=p,q?state.title=q:null}function g(p,q){return 0<l.filter(function(r){if(Array.isArray(r)){var s=r[1](q);return s&&m.emit(r[0],{route:q,event:p}),s}return r(q)}).length}var h=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},j=h.root||document.body,k=h.duration||0,l=h.ignore||[],m=(0,_loop2.default)(),n=(0,_dom2.default)(j,k,m),o=Object.create(_extends({},m,{stop:function stop(){state.paused=!0},start:function start(){state.paused=!1},go:b,push:function(){var p=0<arguments.length&&void 0!==arguments[0]?arguments[0]:state.route,q=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;router.navigate(p),state.route=p,q?state.title=q:null}}),{getState:{value:function value(){return state._state}}});return state.route=window.location.pathname+window.location.search,state.title=document.title,(0,_delegate2.default)(document,'a','click',function(p){var q=p.delegateTarget,r=q.getAttribute('href')||'/',s=(0,_util.sanitize)(r);if(!(!_util.link.isSameOrigin(r)||'external'===q.getAttribute('rel')||q.classList.contains('no-ajax')||g(p,s)||_util.link.isHash(r)))return(p.preventDefault(),!_util.link.isSameURL(r))?(b(_util.origin+'/'+s),!1):void 0}),window.onpopstate=function(p){var q=p.target.location.href;return g(p,q)?_util.link.isHash(q)?void 0:void window.location.reload():void b(q,null,!0)},'scrollRestoration'in history&&(history.scrollRestoration='manual',history.state&&void 0!==history.state.scrollTop&&window.scrollTo(0,history.state.scrollTop),window.onbeforeunload=_util.saveScrollPosition),o};